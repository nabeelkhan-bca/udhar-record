<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Shop Ledger — Mobile-style Interface</title>
  <style>
    /* Mobile-first beautiful UI */
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--glass:rgba(255,255,255,0.03);--muted:rgba(255,255,255,0.6);--success:#10b981;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;color:#fff;background:linear-gradient(180deg,#071026 0%, #081226 60%)}
    .app{max-width:420px;margin:18px auto;padding:12px}
    .topbar{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);border-radius:14px;padding:12px;margin-top:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;padding:10px;border-radius:10px;border:none;background:var(--glass);color:#fff;font-size:15px}
    input::placeholder{color:rgba(255,255,255,0.35)}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .small{font-size:13px;padding:8px 10px;border-radius:10px}
    .btn{background:linear-gradient(90deg,var(--accent),#7c3aed);border:none;color:#021024;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);}

    .toggle{display:flex;background:rgba(255,255,255,0.03);border-radius:12px;padding:4px;width:220px}
    .toggle button{flex:1;border-radius:10px;padding:8px;border:none;background:transparent;color:var(--muted);font-weight:700}
    .toggle button.active{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#021024}

    .balance{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
    .balance .big{font-size:18px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}

    .search{display:flex;gap:8px;margin-top:10px}
    .search input{flex:1}

    /* transactions list */
    .list{margin-top:12px;max-height:420px;overflow:auto;padding-right:6px}
    .date-block{margin-top:10px}
    .date-block h3{font-size:13px;margin:6px 0;color:var(--muted)}
    .tx{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);margin-bottom:8px}
    .tx .meta{flex:1}
    .tx .amt{font-weight:800}
    .tx .type-debit{color:var(--success)}
    .tx .type-credit{color:var(--danger)}

    .footer-actions{display:flex;gap:8px;margin-top:8px}
    .small-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:10px;color:var(--muted)}

    @media(min-width:760px){.app{transform:translateY(10px)}}

    /* small print styling for exported print */
    @media print{body{background:#fff;color:#000} .topbar,.footer-actions,.search,.card form{display:none} }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="logo">SL</div>
      <div>
        <h1>Shop Ledger — Mobile View</h1>
        <div class="muted">Fast receive / pay flow — shows last balance</div>
      </div>
    </div>

    <div class="card">
      <form id="txForm">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="toggle" role="tablist">
            <button type="button" id="btnReceive" class="active">Receive</button>
            <button type="button" id="btnPay">Pay</button>
          </div>
          <div style="text-align:right">
            <div class="muted" style="font-size:12px">Today</div>
            <div id="todayDate" class="muted"></div>
          </div>
        </div>

        <label>Customer name</label>
        <input id="name" placeholder="Enter name" required />

        <div class="row" style="margin-top:8px">
          <div>
            <label>Mobile</label>
            <input id="mobile" inputmode="numeric" maxlength="10" placeholder="10 digits" />
          </div>
          <div>
            <label>Aadhaar</label>
            <input id="aadhaar" inputmode="numeric" maxlength="12" placeholder="12 digits (opt)" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>Amount</label>
            <input id="amount" inputmode="decimal" type="number" step="0.01" placeholder="0.00" required />
          </div>
          <div style="width:120px">
            <label>Mode</label>
            <select id="mode"><option>Cash</option><option>UPI</option><option>Card</option><option>AEPS</option></select>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Last balance</label>
          <div class="balance">
            <div>
              <div class="muted">Previous</div>
              <div class="big" id="prevBalance">₹0.00</div>
            </div>
            <div style="text-align:right">
              <div class="muted">New</div>
              <div class="big" id="newBalance">₹0.00</div>
            </div>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Remarks</label>
          <input id="remarks" placeholder="Optional notes" />
        </div>

        <div class="footer-actions">
          <button class="btn" type="submit">Save</button>
          <button type="button" id="quickClear" class="small-ghost">Clear</button>
          <button type="button" id="exportCsv" class="small-ghost">Export CSV</button>
        </div>
      </form>

      <div class="search">
        <input id="search" placeholder="Search name or mobile" />
        <button id="openAll" class="small-ghost">All</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Summary</div>
          <div style="font-weight:800;font-size:16px">Total Tx: <span id="txCount">0</span></div>
        </div>
        <div style="text-align:right">
          <div class="muted">Total In</div>
          <div class="big" id="totalIn">₹0.00</div>
        </div>
      </div>

      <div class="list" id="txList"></div>
    </div>

  </div>

  <script>
    // Mobile-first ledger logic
    const STORAGE_KEY = 'shop_ledger_mobile_v1';
    function $(id){return document.getElementById(id)}

    const todayDate = new Date().toISOString().slice(0,10);
    $('todayDate').textContent = todayDate;

    function load(){return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}
    function save(v){localStorage.setItem(STORAGE_KEY,JSON.stringify(v))}

    function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}

    // UI elements
    const btnReceive = $('btnReceive'), btnPay = $('btnPay');
    const typeState = {val:'receive'}; // receive = customer paid (debit in old logic), pay = shop paid to customer (credit-ish)

    btnReceive.addEventListener('click', ()=>{typeState.val='receive'; btnReceive.classList.add('active'); btnPay.classList.remove('active'); calcNewBalance();});
    btnPay.addEventListener('click', ()=>{typeState.val='pay'; btnPay.classList.add('active'); btnReceive.classList.remove('active'); calcNewBalance();});

    // form fields
    const nameEl = $('name'), mobileEl = $('mobile'), aadhaarEl = $('aadhaar'), amountEl = $('amount'), modeEl = $('mode'), remarksEl = $('remarks');
    const prevBalanceEl = $('prevBalance'), newBalanceEl = $('newBalance');

    // helper: find last balance by aadhaar -> mobile -> name
    function findLastBalance(name,mobile,aadhaar){
      const data = load();
      // search most recent transaction matching identifiers
      for(let i=data.length-1;i>=0;i--){
        const t = data[i];
        if(aadhaar && t.aadhaar===aadhaar) return t.balance;
        if(mobile && t.mobile===mobile) return t.balance;
        if(name && t.name.toLowerCase()===name.toLowerCase()) return t.balance;
      }
      return 0;
    }

    function calcNewBalance(){
      const amt = parseFloat(amountEl.value) || 0;
      const name = nameEl.value.trim(); const mobile = mobileEl.value.trim(); const aadhaar = aadhaarEl.value.trim();
      const last = parseFloat(findLastBalance(name,mobile,aadhaar)) || 0;
      prevBalanceEl.textContent = '₹' + last.toFixed(2);
      let newBal;
      if(typeState.val === 'receive'){
        // customer paid money to shop => reduces their due
        newBal = (last - amt);
      } else {
        // shop paid to customer => increases shop's payout to customer (i.e., more negative for shop). We'll treat as last + amt
        newBal = (last + amt);
      }
      newBalanceEl.textContent = '₹' + Number(newBal || 0).toFixed(2);
      return {last: last, newBal: newBal};
    }

    // update calc when inputs change
    [nameEl, mobileEl, aadhaarEl, amountEl].forEach(el=>el.addEventListener('input', calcNewBalance));

    // save
    $('txForm').addEventListener('submit', function(e){
      e.preventDefault();
      const name = nameEl.value.trim();
      const mobile = mobileEl.value.trim();
      const aadhaar = aadhaarEl.value.trim();
      const amt = parseFloat(amountEl.value) || 0;
      if(!name){alert('Name required'); return}
      if(mobile && !/^\d{10}$/.test(mobile)){
        if(!confirm('Mobile not 10 digits. Continue?')) return;
      }
      if(aadhaar && !/^\d{12}$/.test(aadhaar)){
        if(!confirm('Aadhaar not 12 digits. Continue?')) return;
      }

      const data = load();
      const last = parseFloat(findLastBalance(name,mobile,aadhaar)) || 0;
      let newBal = (typeState.val==='receive') ? (last - amt) : (last + amt);

      const tx = {id:uid(), date: new Date().toISOString().slice(0,10), name, mobile, aadhaar, type: typeState.val, amount: amt, mode: modeEl.value, balance: Number(newBal.toFixed(2)), remarks: remarksEl.value.trim() }
      data.push(tx);
      save(data);

      // reset amount and remarks but keep name/mobile for quick multiple entries
      amountEl.value=''; remarksEl.value=''; calcNewBalance(); renderList();
    });

    $('quickClear').addEventListener('click', ()=>{nameEl.value='';mobileEl.value='';aadhaarEl.value='';amountEl.value='';remarksEl.value='';calcNewBalance();});

    // render grouped by date
    function groupByDate(arr){
      const out = {};
      arr.forEach(tx=>{if(!out[tx.date]) out[tx.date]=[]; out[tx.date].push(tx)});
      // order dates desc
      const keys = Object.keys(out).sort((a,b)=> new Date(b)-new Date(a));
      return {keys, out};
    }

    function renderList(){
      const data = load();
      const q = $('search').value.trim().toLowerCase();
      const filtered = data.filter(tx=>{
        if(!q) return true;
        return tx.name.toLowerCase().includes(q) || (tx.mobile||'').includes(q) || (tx.aadhaar||'').includes(q);
      });
      const grouped = groupByDate(filtered);
      const container = $('txList'); container.innerHTML='';
      let totalIn=0, totalCount=0;

      grouped.keys.forEach(date=>{
        const block = document.createElement('div'); block.className='date-block';
        const h = document.createElement('h3'); h.textContent = new Date(date).toLocaleDateString(); block.appendChild(h);
        grouped.out[date].forEach(tx=>{
          totalCount++;
          const div = document.createElement('div'); div.className='tx';
          div.innerHTML = `
            <div class="meta">
              <div style="font-weight:700">${escape(tx.name)} <span class="muted">• ${tx.mobile||''}</span></div>
              <div class="muted">${tx.mode} — ${tx.remarks||''}</div>
            </div>
            <div style="text-align:right">
              <div class="amt ${tx.type==='receive'? 'type-debit':'type-credit'}">₹${Number(tx.amount).toFixed(2)}</div>
              <div class="muted">Bal ₹${Number(tx.balance).toFixed(2)}</div>
            </div>
          `;
          // actions on long press / click: delete & whatsapp
          const right = div.querySelector('.amt');
          div.addEventListener('click', ()=>{ if(confirm('Delete this entry?')){ deleteTx(tx.id); } });
          block.appendChild(div);

          if(tx.type === 'receive') totalIn += tx.amount;
        });
        container.appendChild(block);
      });

      $('txCount').textContent = totalCount;
      $('totalIn').textContent = '₹' + totalIn.toFixed(2);

      // update prev balance shown if focused on a customer
      calcNewBalance();
    }

    function deleteTx(id){
      const data = load().filter(t=>t.id!==id); save(data); renderList();
    }

    function escape(s){return String(s||'').replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}

    // search handlers
    $('search').addEventListener('input', renderList);
    $('openAll').addEventListener('click', ()=>{ $('search').value=''; renderList(); });

    // export CSV
    $('exportCsv').addEventListener('click', ()=>{
      const data = load();
      if(!data.length){alert('No data to export');return}
      const header = ['Date','Name','Mobile','Aadhaar','Type','Amount','Mode','Balance','Remarks'];
      const lines = [header.join(',')];
      data.forEach(r=>{
        const line = [r.date,r.name,r.mobile||'',r.aadhaar||'',r.type,r.amount,r.mode,r.balance,(r.remarks||'').replace(/\n/g,' ')];
        lines.push(line.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='ledger.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // autofill based on aadhaar or mobile
    aadhaarEl.addEventListener('input', ()=>{ if(aadhaarEl.value.trim().length>=4){ const last = findMetaById(aadhaarEl.value.trim()); if(last){ nameEl.value = last.name || nameEl.value; mobileEl.value = last.mobile || mobileEl.value; calcNewBalance(); } } });
    mobileEl.addEventListener('input', ()=>{ if(mobileEl.value.trim().length>=4){ const last = findMetaById(mobileEl.value.trim()); if(last){ nameEl.value = last.name || nameEl.value; aadhaarEl.value = last.aadhaar || aadhaarEl.value; calcNewBalance(); } } });

    function findMetaById(id){ const data = load(); for(let i=data.length-1;i>=0;i--){ const t=data[i]; if(t.aadhaar===id || t.mobile===id) return t; } return null }

    // initial call
    renderList();
  </script>
</body>
</html>
